<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Master Kids - çµ‚æ¥µç©©å®šç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { 
            -webkit-touch-callout: none; 
            -webkit-user-select: none; 
            overscroll-behavior: none;
            font-family: 'system-ui', -apple-system, sans-serif;
        }
        .correct-anim { animation: pop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 60% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .mic-wave span {
            display: inline-block;
            width: 4px;
            height: 10px;
            background-color: white;
            border-radius: 2px;
            animation: wave 1s infinite ease-in-out;
            margin: 0 2px;
        }
        .mic-wave span:nth-child(1) { animation-delay: 0.1s; height: 15px; }
        .mic-wave span:nth-child(2) { animation-delay: 0.2s; height: 25px; }
        .mic-wave span:nth-child(3) { animation-delay: 0.3s; height: 15px; }
        @keyframes wave { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(1.5); } }
        
        .backdrop-blur-sm { backdrop-filter: blur(4px); }
    </style>
</head>
<body class="bg-indigo-50 text-slate-800">

    <div id="app" class="min-h-screen flex flex-col items-center max-w-md mx-auto bg-white shadow-2xl min-h-screen relative overflow-hidden">
        <div class="flex items-center justify-center h-screen text-slate-400">
            ç³»çµ±è¼‰å…¥ä¸­...
        </div>
    </div>

    <script>
        // ==========================================
        //  å–®å­—è³‡æ–™åº«
        // ==========================================
        const RAW_WORD_DATA = {
            // Level 1: KK éŸ³æ¨™ (speakText å„ªåŒ–)
            level1: [
                { en: "[i]", zh: "ã„§ (é•·éŸ³)", ipa: "/i/", note: "å˜´è§’å‘å…©æ—æ‹‰é–‹å¾®ç¬‘ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šä¸€ (é•·éŸ³)</span>", speakText: "Ee, Ee, Eat" },
                { en: "[Éª]", zh: "ã„§ (çŸ­éŸ³)", ipa: "/Éª/", note: "å˜´è§’æ”¾é¬†ï¼ŒçŸ­ä¿ƒç™¼éŸ³ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šä¸€ (çŸ­ä¿ƒ)</span>", speakText: "Ih, Ih, It" },
                { en: "[e]", zh: "ã„ä¸€ (é›™æ¯éŸ³)", ipa: "/e/", note: "å…ˆå”¸ã„å†æ»‘å‘ä¸€ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šã„ä¸€</span>", speakText: "Ay, Ay, Eight" },
                { en: "[É›]", zh: "ã„ (çŸ­éŸ³)", ipa: "/É›/", note: "å˜´å·´å¾®å¼µï¼ŒçŸ­ä¿ƒæœ‰åŠ›ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šã„</span>", speakText: "Eh, Eh, Egg" },
                { en: "[Ã¦]", zh: "è´è¶éŸ³", ipa: "/Ã¦/", note: "å˜´å·´å¼µå¤§æˆã€Œå•Šã€çš„å½¢ç‹€å”¸ã€Œã„ã€ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šæ¢… (çš„éŸ»æ¯)</span>", speakText: "A, A, Apple" },
                { en: "[É‘]", zh: "å•Š (å¤§å£)", ipa: "/É‘/", note: "å˜´å·´ä¸Šä¸‹æ‹‰å¤§ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šå•Š (çœ‹ç‰™é†«æ™‚)</span>", speakText: "Ah, Ah, Hot" },
                { en: "[ÊŒ]", zh: "å•Š (çŸ­éŸ³)", ipa: "/ÊŒ/", note: "å˜´å·´å¾®å¼µï¼ŒçŸ­ä¿ƒã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šå•Š (çŸ­)</span>", speakText: "Uh, Uh, Up" },
                { en: "[É™]", zh: "ã„œ (è¼•éŸ³)", ipa: "/É™/", note: "å˜´å·´æ”¾é¬†ï¼Œè¼•è¼•å”¸ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šã„œ (è¼•è²)</span>", speakText: "Uh, Uh, About" },
                { en: "[É”]", zh: "å–” (é•·éŸ³)", ipa: "/É”/", note: "å˜´å·´åœ“åœ“çš„ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šå–”</span>", speakText: "Aw, Aw, Ball" },
                { en: "[o]", zh: "æ­ (é›™æ¯éŸ³)", ipa: "/o/", note: "å…ˆå”¸å–”å†æ»‘å‘ã„¨ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šæ­</span>", speakText: "Oh, Oh, Go" },
                { en: "[u]", zh: "å—š (é•·éŸ³)", ipa: "/u/", note: "å˜´å”‡å˜Ÿåœ“ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šå—š (é•·)</span>", speakText: "Oo, Oo, Food" },
                { en: "[ÊŠ]", zh: "å—š (çŸ­éŸ³)", ipa: "/ÊŠ/", note: "å˜´å·´æ”¾é¬†ä¸€é»ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šå—š (çŸ­)</span>", speakText: "Uh, Uh, Book" },
                { en: "[É]", zh: "å„¿ (é•·éŸ³)", ipa: "/3/ or /É/", note: "æ²èˆŒéŸ³ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šäºŒ (æ²èˆŒ)</span>", speakText: "Er, Er, Bird" },
                { en: "[Éš]", zh: "å„¿ (çŸ­éŸ³)", ipa: "/2/ or /Éš/", note: "è¼•è²æ²èˆŒã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šäºŒ (è¼•è²)</span>", speakText: "Er, Er, Sister" },
                { en: "[aÉª]", zh: "ã„", ipa: "/aÉª/", note: "å•Š+ä¸€ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šæ„›</span>", speakText: "Eye, Eye, Ice" },
                { en: "[aÊŠ]", zh: "ã„ ", ipa: "/aÊŠ/", note: "å•Š+å—šã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šå¥§</span>", speakText: "Ow, Ow, Out" },
                { en: "[É”Éª]", zh: "ã„›ä¸€", ipa: "/É”Éª/", note: "å–”+ä¸€ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šå–”ä¸€</span>", speakText: "Oy, Oy, Boy" }
            ],
            // Level 2: è¤‡åˆå­éŸ³ (speakText æ“¬è²)
            level2: [
                { en: "CH", zh: "CH ç™¼éŸ³", ipa: "/tÊƒ/", note: "æ°£éŸ³ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šå» / åƒ</span>", speakText: "Chuh, Cheese" },
                { en: "SH", zh: "SH ç™¼éŸ³", ipa: "/Êƒ/", note: "æ°£éŸ³ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šå™“</span>", speakText: "Shuh, Sheep" },
                { en: "TH", zh: "TH (ç„¡è²)", ipa: "/Î¸/", note: "å’¬èˆŒé ­å¹æ°£ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šæ–¯ (å¤§èˆŒé ­)</span>", speakText: "Th, Thank" },
                { en: "TH", zh: "TH (æœ‰è²)", ipa: "/Ã°/", note: "å’¬èˆŒé ­éœ‡å‹•ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šæ—¥ (å¤§èˆŒé ­)</span>", speakText: "Th, This" },
                { en: "PH", zh: "PH ç™¼éŸ³", ipa: "/f/", note: "å’¬ä¸‹å”‡ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šå¤«</span>", speakText: "Fuh, Phone" },
                { en: "WH", zh: "WH ç™¼éŸ³", ipa: "/w/", note: "åœ“å”‡ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šã„¨</span>", speakText: "Wuh, White" },
                { en: "NG", zh: "NG å­—å°¾éŸ³", ipa: "/Å‹/", note: "é¼»éŸ³ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šå—¯ (Singçš„å°¾éŸ³)</span>", speakText: "Ing, Sing" },
                { en: "CK", zh: "CK å­—å°¾éŸ³", ipa: "/k/", note: "çŸ­ä¿ƒã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šå…‹</span>", speakText: "Kuh, Duck" },
                { en: "QU", zh: "QU ç™¼éŸ³", ipa: "/kw/", note: "åœ“å”‡å¼µé–‹ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šå¤¸</span>", speakText: "Kwuh, Queen" },
                { en: "BL", zh: "BL æ··åˆéŸ³", ipa: "/bl/", note: "ç·Šé–‰é›™å”‡å¾Œå½ˆé–‹ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šå¸ƒé­¯</span>", speakText: "Buh, Luh, Blue" },
                { en: "CL", zh: "CL æ··åˆéŸ³", ipa: "/kl/", note: "èˆŒæ ¹éŸ³ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šå…‹é­¯</span>", speakText: "Kuh, Luh, Class" },
                { en: "FL", zh: "FL æ··åˆéŸ³", ipa: "/fl/", note: "å’¬ä¸‹å”‡ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šå¤«é­¯</span>", speakText: "Fuh, Luh, Fly" },
                { en: "GL", zh: "GL æ··åˆéŸ³", ipa: "/gl/", note: "èˆŒæ ¹éŸ³ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šè‘›é­¯</span>", speakText: "Guh, Luh, Glass" },
                { en: "PL", zh: "PL æ··åˆéŸ³", ipa: "/pl/", note: "ç·Šé–‰é›™å”‡ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šæ™®é­¯</span>", speakText: "Puh, Luh, Play" },
                { en: "SL", zh: "SL æ··åˆéŸ³", ipa: "/sl/", note: "æ°£éŸ³ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šæ–¯é­¯</span>", speakText: "Suh, Luh, Slow" },
                { en: "BR", zh: "BR æ··åˆéŸ³", ipa: "/br/", note: "æ²èˆŒã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šå¸ƒè‹¥</span>", speakText: "Buh, Ruh, Bread" },
                { en: "CR", zh: "CR æ··åˆéŸ³", ipa: "/kr/", note: "æ²èˆŒã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šå…‹è‹¥</span>", speakText: "Kuh, Ruh, Cry" },
                { en: "DR", zh: "DR æ··åˆéŸ³", ipa: "/dr/", note: "æ²èˆŒã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šæœ±è‹¥</span>", speakText: "Duh, Ruh, Dream" },
                { en: "FR", zh: "FR æ··åˆéŸ³", ipa: "/fr/", note: "å’¬ä¸‹å”‡æ²èˆŒã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šå¤«è‹¥</span>", speakText: "Fuh, Ruh, Frog" },
                { en: "GR", zh: "GR æ··åˆéŸ³", ipa: "/gr/", note: "æ²èˆŒã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šè‘›è‹¥</span>", speakText: "Guh, Ruh, Green" },
                { en: "PR", zh: "PR æ··åˆéŸ³", ipa: "/pr/", note: "æ²èˆŒã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šæ™®è‹¥</span>", speakText: "Puh, Ruh, Price" },
                { en: "SP", zh: "SP æ··åˆéŸ³", ipa: "/sp/", note: "Så¾ŒPä¸é€æ°£ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šæ–¯é€¼</span>", speakText: "Suh, Puh, Speak" },
                { en: "ST", zh: "ST æ··åˆéŸ³", ipa: "/st/", note: "Så¾ŒTä¸é€æ°£ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šæ–¯æ»´</span>", speakText: "Suh, Tuh, Stop" },
                { en: "SW", zh: "SW æ··åˆéŸ³", ipa: "/sw/", note: "åœ“å”‡ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šæ–¯æˆ‘</span>", speakText: "Suh, Wuh, Swim" },
                { en: "SCR", zh: "SCR æ··åˆéŸ³", ipa: "/skr/", note: "ä¸‰éŸ³é€£è®€ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šæ–¯æ ¼è‹¥</span>", speakText: "Scr, Screen" },
                { en: "SHR", zh: "SHR æ··åˆéŸ³", ipa: "/Êƒr/", note: "å™“+æ²èˆŒã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šè¨±è‹¥</span>", speakText: "Shr, Shrimp" },
                { en: "SPL", zh: "SPL æ··åˆéŸ³", ipa: "/spl/", note: "ä¸‰éŸ³é€£è®€ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šæ–¯å¸ƒé­¯</span>", speakText: "Spl, Splash" },
                { en: "SPR", zh: "SPR æ··åˆéŸ³", ipa: "/spr/", note: "ä¸‰éŸ³é€£è®€ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šæ–¯å¸ƒè‹¥</span>", speakText: "Spr, Spring" },
                { en: "STR", zh: "STR æ··åˆéŸ³", ipa: "/str/", note: "ä¸‰éŸ³é€£è®€ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šæ–¯æœ±è‹¥</span>", speakText: "Str, Street" },
                { en: "THR", zh: "THR æ··åˆéŸ³", ipa: "/Î¸r/", note: "å’¬èˆŒ+æ²èˆŒã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šæ–¯è‹¥</span>", speakText: "Thr, Three" }
            ],
            // Level 3 ~ 10 ç¶­æŒåŸæ¨£ (å·²æ–¼å‰æ¬¡æ“´å……ï¼Œé€™è£¡åƒ…åˆ—éƒ¨åˆ†ä½œç‚ºç¯„ä¾‹)
            level3: [ { en: "Book", zh: "æ›¸", ipa: "/bÊŠk/", note: "oo ç™¼çŸ­éŸ³ /ÊŠ/ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šå¸ƒå¯</span>" }, { en: "Cat", zh: "è²“", ipa: "/kÃ¦t/", note: "a ç™¼è´è¶éŸ³ /Ã¦/ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šå‡±ç‰¹</span>" } ],
            level4: [ { en: "Family", zh: "å®¶åº­", ipa: "/ËˆfÃ¦mÉ™li/", note: "a ç™¼ /Ã¦/ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šééº¼é›¢</span>" } ],
            level5: [ { en: "Apple", zh: "è˜‹æœ", ipa: "/ËˆÃ¦pl/", note: "a ç™¼ /Ã¦/ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šã„Ÿ-å‰–</span>" } ],
            level6: [ { en: "Student", zh: "å­¸ç”Ÿ", ipa: "/Ëˆstudnt/", note: "u ç™¼ /u/ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šæ­»-ä¸Ÿ-ç­‰t</span>" } ],
            level7: [ { en: "Do you need a hand?", zh: "ä½ éœ€è¦å¹«å¿™å—ï¼Ÿ", ipa: "/nid É™ hÃ¦nd/", note: "Need a é€£è®€ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šåº¦ æ²¹ å°¼ ã„œ æ¼¢?</span>" } ],
            level8: [ { en: "Go", zh: "å»", ipa: "/goÊŠ/", note: "o ç™¼ /oÊŠ/ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šè³¼</span>" } ],
            level9: [ { en: "Time", zh: "æ™‚é–“", ipa: "/taÉªm/", note: "i ç™¼ /aÉª/ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šæ³°m</span>" } ],
            level10: [ { en: "Acquire", zh: "ç²å¾—", ipa: "/É™ËˆkwaÉªÉ™r/", note: "A ç™¼ /É™/ã€‚<br><span class='text-indigo-600 font-bold'>éŸ³ä¼¼ï¼šé¡-å¿«-çˆ¾</span>" } ]
        };

        // æ“´å……å¾Œçš„è³‡æ–™å®¹å™¨
        let WORD_DATA = {};
        const QUESTIONS_PER_ROUND = 20;
        const TARGET_WORD_COUNT = 600;

        function expandDataTo600() {
            WORD_DATA = JSON.parse(JSON.stringify(RAW_WORD_DATA));
            for (const level in WORD_DATA) {
                if (level === 'level1') continue;
                const originalWords = WORD_DATA[level];
                const currentCount = originalWords.length;
                if (currentCount < TARGET_WORD_COUNT) {
                    const needed = TARGET_WORD_COUNT - currentCount;
                    for (let i = 0; i < needed; i++) {
                        const sourceWord = originalWords[i % currentCount];
                        WORD_DATA[level].push({
                            en: sourceWord.en, 
                            zh: sourceWord.zh,
                            ipa: sourceWord.ipa,
                            note: sourceWord.note,
                            speakText: sourceWord.speakText
                        });
                    }
                }
                WORD_DATA[level].sort(() => 0.5 - Math.random());
            }
        }

        const LEVELS = [
            { id: 'level1', title: '1. æ¯éŸ³åŸºç¤', desc: 'ç´”æ¯éŸ³ (A, E, I, O, U) ç™¼éŸ³å˜´å‹', color: 'bg-yellow-400' },
            { id: 'level2', title: '2. è¤‡åˆå­éŸ³', desc: 'Digraphs (CH/SH) & Blends (BL/STR)', color: 'bg-orange-400' },
            { id: 'level3', title: '3. åœ‹å°å–®å­—', desc: 'åŸºç¤å­—å½™èˆ‡çŸ­æ¯éŸ³', color: 'bg-green-400' },
            { id: 'level4', title: '4. åœ‹ä¸­å–®å­—', desc: 'é€²éšé–±è®€å­—å½™', color: 'bg-teal-400' },
            { id: 'level5', title: '5. é«˜ä¸€æ ¸å¿ƒ', desc: 'å­¸è¡“å…¥é–€å­—å½™', color: 'bg-blue-400' },
            { id: 'level6', title: '6. é«˜äºŒé€²éš', desc: 'æ·±åº¦é–±è®€å­—å½™', color: 'bg-indigo-400' },
            { id: 'level7', title: '7. æ—¥å¸¸æœƒè©±', desc: '600å¥é“åœ°ç”Ÿæ´»çŸ­å¥', color: 'bg-purple-400' },
            { id: 'level8', title: '8. æ–‡æ³•å‹•è©', desc: 'å‹•è©è®ŠåŒ–èˆ‡æ–‡æ³•', color: 'bg-pink-400' },
            { id: 'level9', title: '9. é«˜ä¸‰ç²¾é€²', desc: 'å­¸è¡“èˆ‡æŠ½è±¡æ¦‚å¿µ', color: 'bg-rose-400' },
            { id: 'level10', title: '10. å­¸æ¸¬/å¤šç›Š', desc: 'é«˜é »è€ƒè©¦å¿…å‚™å–®å­—', color: 'bg-stone-500' }
        ];

        let state = {
            view: 'home',
            currentLevelId: '',
            questions: [],
            currentIndex: 0,
            score: 0,
            status: 'idle',
            transcript: '', 
            feedbackMsg: '',
            isSecure: window.location.protocol === 'https:' || window.location.hostname === 'localhost',
            speechSupported: false,
            ttsSupported: false,
            showHelpModal: false,
            isSkipping: false // æ–°å¢ï¼šé˜²æ­¢è·³é¡Œæ™‚éŒ„éŸ³å›å‚³å¹²æ“¾
        };

        function initTTS() {
            if ('speechSynthesis' in window) {
                state.ttsSupported = true;
                window.speechSynthesis.getVoices();
            }
        }

        function speak(text, overrideText) {
            if (!state.ttsSupported) return;
            try { window.speechSynthesis.cancel(); } catch(e){}
            
            let textToSpeak = overrideText || text;
            const currentQ = state.questions[state.currentIndex];
            if (!overrideText && currentQ && currentQ.en === text && currentQ.speakText) {
                textToSpeak = currentQ.speakText;
            } else if (!overrideText) {
                textToSpeak = text.replace(/\s*\(\d+\)/, "");
            }
            
            const u = new SpeechSynthesisUtterance(textToSpeak);
            u.lang = 'en-US';
            u.rate = 0.8; 
            const voices = window.speechSynthesis.getVoices();
            const enVoice = voices.find(v => v.lang === 'en-US' && v.name.includes('Google')) || 
                            voices.find(v => v.lang === 'en-US');
            if(enVoice) u.voice = enVoice;
            window.speechSynthesis.speak(u);
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;

        function initSTT() {
            if (SpeechRecognition) {
                state.speechSupported = true;
                recognition = new SpeechRecognition();
                recognition.lang = 'en-US';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = () => {
                    if (state.isSkipping) return; // å¦‚æœæ­£åœ¨è·³é¡Œï¼Œå¿½ç•¥
                    state.status = 'listening';
                    state.transcript = '';
                    state.feedbackMsg = 'è«‹ç™¼éŸ³...';
                    render();
                };

                recognition.onresult = (event) => {
                    if (state.isSkipping) return; // å¦‚æœæ­£åœ¨è·³é¡Œï¼Œå¿½ç•¥
                    const result = event.results[0][0].transcript;
                    state.transcript = result;
                    evaluate(result);
                    recognition.stop();
                };

                recognition.onerror = (e) => {
                    if (state.isSkipping) return;
                    console.log('Error', e);
                    if (e.error === 'not-allowed') {
                        state.status = 'fail';
                        state.feedbackMsg = 'æ¬Šé™è¢«æ‹’';
                        state.showHelpModal = true;
                        render();
                    } else {
                        // å®‰éœè™•ç†éŒ¯èª¤ï¼Œä¸è·³ç´…å­—ï¼Œç›´æ¥é‡ç½®
                        state.status = 'idle';
                        state.feedbackMsg = 'è«‹å†è©¦ä¸€æ¬¡';
                        render();
                    }
                };

                recognition.onend = () => {
                    if (state.isSkipping) return;
                    if (state.status === 'listening') {
                        state.status = 'idle';
                        state.feedbackMsg = 'æ²’è½åˆ°è²éŸ³';
                        render();
                    }
                };
            }
        }

        function startRecording() {
            if (!state.speechSupported) {
                alert("ç€è¦½å™¨ä¸æ”¯æ´éŒ„éŸ³");
                return;
            }
            state.isSkipping = false; // é‡ç½®è·³é¡Œæ——æ¨™
            try { recognition.start(); } catch(e) {}
        }

        function evaluate(userSay) {
            if (state.isSkipping) return;

            const currentQ = state.questions[state.currentIndex];
            const normalize = (str) => str.replace(/\s*\(\d+\)/, "").toLowerCase().replace(/[^a-z0-9]/g, "");
            const targetClean = normalize(currentQ.en);
            const userClean = normalize(userSay);

            let isCorrect = userClean === targetClean || userClean.includes(targetClean) || targetClean.includes(userClean);
            
            // Level 1 & 2 é¼“å‹µæ¨¡å¼ï¼šæœ‰æ”¶åˆ°è²éŸ³å°±ç®—å°
            if (state.currentLevelId === 'level1' || state.currentLevelId === 'level2') {
                if (userSay.trim().length > 0) isCorrect = true;
            }

            if (isCorrect) {
                state.status = 'success';
                state.score += 5; 
                state.feedbackMsg = `Correct!`;
                speak(currentQ.en);
                render();
                setTimeout(() => {
                    if (!state.isSkipping) nextQuestion();
                }, 2000);
            } else {
                state.status = 'fail';
                state.feedbackMsg = `è½åˆ°: "${userSay}"`;
                speak(currentQ.en);
                render();
            }
        }

        function startGame(levelId) {
            const allWords = WORD_DATA[levelId];
            if (levelId === 'level1') {
                state.questions = [...allWords];
            } else {
                state.questions = [...allWords].sort(() => 0.5 - Math.random()).slice(0, QUESTIONS_PER_ROUND);
            }
            state.currentLevelId = levelId;
            state.currentIndex = 0;
            state.score = 0;
            state.view = 'game';
            state.status = 'idle';
            state.transcript = '';
            state.feedbackMsg = '';
            state.isSkipping = false; // é‡ç½®
            render();
            setTimeout(() => speak(state.questions[0].en), 600);
        }

        function nextQuestion() {
            // è¨­å®šæ——æ¨™ï¼Œé˜²æ­¢èˆŠçš„éŒ„éŸ³å›èª¿å¹²æ“¾
            state.isSkipping = true; 
            if (recognition) try { recognition.abort(); } catch(e){}
            
            // å¼·åˆ¶é‡ç½®ç‹€æ…‹
            setTimeout(() => {
                state.isSkipping = false;
                state.status = 'idle';
                state.transcript = '';
                state.feedbackMsg = '';

                if (state.currentIndex < state.questions.length - 1) {
                    state.currentIndex++;
                    render();
                    speak(state.questions[state.currentIndex].en);
                } else {
                    state.view = 'result';
                    render();
                    speak("Mission Complete!");
                }
            }, 100); // å¾®å°å»¶é²ç¢ºä¿ abort å®Œæˆ
        }

        function goHome() {
            state.view = 'home';
            render();
        }

        function toggleHelp(show) {
            state.showHelpModal = show;
            render();
        }

        function highlightVowels(word) {
            const displayWord = word.replace(/\s*\(\d+\)/, "");
            if (displayWord.startsWith('[') && displayWord.endsWith(']')) return displayWord;
            return displayWord.replace(/([aeiouAEIOU])/g, '<span class="text-rose-500">$1</span>');
        }

        function render() {
            const app = document.getElementById('app');
            let html = '';

            let secureWarning = '';
            if (!state.isSecure && state.view === 'home') {
                secureWarning = `<div class="bg-amber-100 text-amber-800 px-4 py-2 text-xs text-center border-b border-amber-200">âš ï¸ ç¶²å€é HTTPSï¼Œéº¥å…‹é¢¨å¯èƒ½æœƒå¤±æ•ˆ</div>`;
            }

            let helpModalHtml = '';
            if (state.showHelpModal) {
                helpModalHtml = `
                    <div class="absolute inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 fade-in">
                        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl relative">
                            <button onclick="toggleHelp(false)" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i data-lucide="x-circle" class="w-8 h-8"></i></button>
                            <div class="text-center">
                                <h3 class="text-xl font-bold text-slate-800 mb-4">éº¥å…‹é¢¨è¨­å®š</h3>
                                <p class="text-gray-600 text-sm mb-4">è«‹é»æ“Šç¶²å€åˆ—æ—çš„é–é ­ç¬¦è™Ÿ ğŸ”’ï¼Œä¸¦å…è¨±éº¥å…‹é¢¨æ¬Šé™ã€‚</p>
                                <button onclick="toggleHelp(false)" class="mt-4 w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">æˆ‘çŸ¥é“äº†</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (state.view === 'home') {
                const getCount = (id) => id === 'level1' ? WORD_DATA[id].length : WORD_DATA[id].length;
                html = `
                    ${secureWarning}
                    <div class="w-full p-6 pb-20 fade-in">
                        <header class="mb-6 text-center">
                            <h1 class="text-3xl font-black text-indigo-600 mb-1">English Master</h1>
                            <p class="text-sm text-slate-500">ç©©å®šä¿®æ­£ç‰ˆ</p>
                            ${!state.speechSupported ? '<div class="mt-2 bg-red-100 text-red-600 px-3 py-1 rounded text-xs inline-block">âš ï¸ ç€è¦½å™¨ä¸æ”¯æ´éŒ„éŸ³</div>' : ''}
                        </header>
                        <div class="flex justify-center mb-6">
                            <button onclick="toggleHelp(true)" class="flex items-center gap-2 bg-white border border-slate-200 text-slate-500 px-4 py-2 rounded-full text-sm shadow-sm hover:bg-slate-50">
                                <i data-lucide="settings-2" class="w-4 h-4"></i> è¨­å®šæ•™å­¸
                            </button>
                        </div>
                        <div class="grid gap-4">
                            ${LEVELS.map(lvl => `
                                <button onclick="startGame('${lvl.id}')" class="relative overflow-hidden rounded-2xl shadow-md transition-transform active:scale-95 text-left bg-white border border-slate-100">
                                    <div class="${lvl.color} p-4 text-white">
                                        <div class="font-bold text-lg">${lvl.title}</div>
                                        <div class="text-xs opacity-90">${lvl.desc}</div>
                                    </div>
                                    <div class="p-3 flex justify-between items-center text-slate-500 text-sm">
                                        <span>é–‹å§‹ (${lvl.id === 'level1' ? WORD_DATA['level1'].length : QUESTIONS_PER_ROUND} é¡Œ)</span>
                                        <i data-lucide="mic" class="w-5 h-5"></i>
                                    </div>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else if (state.view === 'game') {
                const q = state.questions[state.currentIndex];
                const isListening = state.status === 'listening';
                const isSuccess = state.status === 'success';
                const isFail = state.status === 'fail';

                let cardClass = "border-indigo-100 shadow-lg";
                if (isListening) cardClass = "border-rose-400 shadow-xl ring-4 ring-rose-50";
                else if (isSuccess) cardClass = "border-green-400 bg-green-50 correct-anim";
                else if (isFail) cardClass = "border-red-300 bg-red-50";

                let textSizeClass = 'text-5xl';
                if (q.en.length > 40) textSizeClass = 'text-lg';      
                else if (q.en.length > 25) textSizeClass = 'text-xl'; 
                else if (q.en.length > 15) textSizeClass = 'text-2xl'; 
                else if (q.en.length > 8) textSizeClass = 'text-4xl'; 

                html = `
                    <div class="w-full h-full flex flex-col p-6 fade-in relative">
                        <div class="flex justify-between items-center mb-4">
                            <button onclick="goHome()" class="p-2 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200"><i data-lucide="arrow-left"></i></button>
                            <div class="font-bold text-slate-400">ç¬¬ ${state.currentIndex + 1} / ${state.questions.length} é¡Œ</div>
                            <div class="bg-yellow-100 text-yellow-600 px-3 py-1 rounded-full font-bold text-sm">${state.score} åˆ†</div>
                        </div>
                        <div class="relative bg-white rounded-3xl p-6 mb-6 border-2 transition-all duration-300 ${cardClass} flex flex-col items-center justify-center min-h-[300px]">
                            <div class="${textSizeClass} font-black text-slate-800 mb-2 text-center tracking-tight break-words leading-tight">${highlightVowels(q.en)}</div>
                            <div class="text-indigo-400 font-mono text-xl mb-2 font-bold bg-indigo-50 px-3 py-1 rounded-lg">${q.ipa || ''}</div>
                            <div class="text-lg text-slate-400 font-medium mb-6">${q.zh}</div>
                            <div class="bg-yellow-50 border border-yellow-100 p-4 rounded-xl text-sm text-yellow-800 w-full text-left leading-relaxed mb-4 shadow-sm">
                                <div class="font-bold text-yellow-600 mb-1 flex items-center gap-1"><i data-lucide="lightbulb" class="w-4 h-4"></i> ç™¼éŸ³æŠ€å·§ï¼š</div>
                                ${q.note || 'è«‹åƒè€ƒéŸ³æ¨™ç™¼éŸ³'}
                            </div>
                            <div class="h-6 text-center w-full">
                                ${isListening ? `<div class="mic-wave flex justify-center items-center h-full text-rose-500 font-bold gap-1"><span></span><span></span><span></span> è†è½ä¸­...</div>` : ''}
                                ${!isListening && state.feedbackMsg ? `<div class="text-sm font-bold ${isSuccess ? 'text-green-600' : 'text-red-500'}">${state.feedbackMsg}</div>` : ''}
                                ${!isListening && !state.feedbackMsg ? `<div class="text-xs text-slate-300">é»æ“Šéº¥å…‹é¢¨ç·´ç¿’</div>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center justify-center gap-8 mb-6 relative z-10">
                            <button onclick="speak('${q.en}')" class="w-16 h-16 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center active:bg-slate-200 transition-colors shadow-sm"><i data-lucide="volume-2" class="w-7 h-7"></i></button>
                            <button onclick="startRecording()" class="w-24 h-24 rounded-full flex items-center justify-center transition-transform active:scale-95 relative group">
                                ${isListening ? `<div class="absolute inset-0 bg-rose-500 rounded-full pulse-ring opacity-50"></div>` : ''}
                                <div class="relative w-full h-full rounded-full flex items-center justify-center shadow-2xl border-4 border-white ${isListening ? 'bg-gradient-to-br from-rose-500 to-red-600' : 'bg-gradient-to-br from-indigo-500 to-blue-600'}"><i data-lucide="mic" class="w-10 h-10 text-white"></i></div>
                            </button>
                        </div>
                        <div class="text-center">
                            <button onclick="nextQuestion()" class="text-slate-400 text-sm py-2 px-4 rounded-full hover:bg-slate-50 transition-colors inline-flex items-center gap-1">è·³é / ä¸‹ä¸€é¡Œ <i data-lucide="skip-forward" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                `;
            } else if (state.view === 'result') {
                html = `
                    <div class="w-full h-full flex flex-col items-center justify-center p-8 fade-in text-center">
                        <div class="text-8xl mb-6 animate-bounce">ğŸ†</div>
                        <h2 class="text-3xl font-black text-slate-800 mb-2">æ¸¬é©—å®Œæˆï¼</h2>
                        <div class="bg-white border-2 border-slate-100 w-full rounded-2xl p-8 mb-8 shadow-sm">
                            <div class="text-slate-400 text-sm mb-2">æœ€çµ‚å¾—åˆ†</div>
                            <div class="text-7xl font-black text-indigo-500">${state.score}</div>
                        </div>
                        <button onclick="startGame('${state.currentLevelId}')" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-all mb-4">å†ç©ä¸€æ¬¡</button>
                        <button onclick="goHome()" class="w-full bg-slate-100 text-slate-500 py-4 rounded-xl font-bold active:scale-95 transition-all">å›åˆ°é¸å–®</button>
                    </div>
                `;
            }
            html += helpModalHtml;
            app.innerHTML = html;
            lucide.createIcons();
            window.state = state;
        }

        // åˆå§‹åŒ–
        expandDataTo600();
        initTTS();
        initSTT();
        render();

    </script>
</body>
</html>