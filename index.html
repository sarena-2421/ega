<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Master Kids - ç›¸å®¹æ€§ä¿®å¾©ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { 
            -webkit-touch-callout: none; 
            -webkit-user-select: none; 
            overscroll-behavior: none;
            font-family: 'system-ui', -apple-system, sans-serif;
        }
        .correct-anim { animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .backdrop-blur-sm { backdrop-filter: blur(4px); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app" class="min-h-screen flex flex-col items-center max-w-md mx-auto bg-white shadow-2xl min-h-screen relative">
        <div class="flex items-center justify-center h-screen text-slate-400">
            ç³»çµ±åˆå§‹åŒ–ä¸­...
        </div>
    </div>

    <script>
        // ==========================================
        //  å–®å­—è³‡æ–™åº« (Data Center)
        // ==========================================
        const WORD_DATA = {
            level1: [
                { en: "A", zh: "å­—æ¯ A", hint: "ã„Ÿ" }, { en: "E", zh: "å­—æ¯ E", hint: "ã„§" },
                { en: "I", zh: "å­—æ¯ I", hint: "æ„›" }, { en: "O", zh: "å­—æ¯ O", hint: "æ­" },
                { en: "U", zh: "å­—æ¯ U", hint: "å„ª" }, { en: "Apple", zh: "è˜‹æœ", hint: "ã„Ÿ ã„†ã„›" },
                { en: "Ant", zh: "èèŸ»", hint: "å®‰ ã„Š" }, { en: "Egg", zh: "é›è›‹", hint: "ã„Ÿ ã„" },
                { en: "Ice", zh: "å†°", hint: "æ„› æ­»" }, { en: "Old", zh: "è€çš„", hint: "æ­ ã„‰" }
            ],
            level2: [
                { en: "Cat", zh: "è²“", hint: "ã„ã„Ÿ ã„Š" }, { en: "Bat", zh: "è™è ", hint: "ã„…ã„Ÿ ã„Š" },
                { en: "Hat", zh: "å¸½å­", hint: "é»‘ ã„Š" }, { en: "Dad", zh: "çˆ¸çˆ¸", hint: "çˆ¹ ã„‰" },
                { en: "Dog", zh: "ç‹—", hint: "ã„‰ã„› ã„" }, { en: "Map", zh: "åœ°åœ–", hint: "å¦¹ ã„†" },
                { en: "Bed", zh: "åºŠ", hint: "è² ã„‰" }, { en: "Pig", zh: "è±¬", hint: "ã„†ã„§ ã„" }
            ],
            level3: [
                { en: "Book", zh: "æ›¸", hint: "å¸ƒ ã„" }, { en: "Pen", zh: "ç­†", hint: "å™´" },
                { en: "Desk", zh: "æ›¸æ¡Œ", hint: "çˆ¹ æ­» ã„" }, { en: "School", zh: "å­¸æ ¡", hint: "æ­» å“­ å–”" },
                { en: "Boy", zh: "ç”·å­©", hint: "æ³¢ ã„§" }, { en: "Girl", zh: "å¥³å­©", hint: "è‘› å–”" },
                { en: "Happy", zh: "å¿«æ¨‚", hint: "é»‘ çš®" }, { en: "One", zh: "ä¸€", hint: "è¬" }
            ],
            level4: [
                { en: "Family", zh: "å®¶åº­", hint: "è‚¥ éº¼ é›¢" }, { en: "Friend", zh: "æœ‹å‹", hint: "å¤« ç‘ æ© ã„‰" },
                { en: "Market", zh: "å¸‚å ´", hint: "ç½µ ã„ã„§ ã„Š" }, { en: "Dinner", zh: "æ™šé¤", hint: "æ»´ å‘¢" },
                { en: "Music", zh: "éŸ³æ¨‚", hint: "è¬¬ å¸Œ ã„" }, { en: "Sport", zh: "é‹å‹•", hint: "æ­» æ³¢ ã„Š" },
                { en: "Money", zh: "éŒ¢", hint: "åª½ å°¼" }, { en: "Phone", zh: "é›»è©±", hint: "é³³" }
            ],
            level5: [
                { en: "Ability", zh: "èƒ½åŠ›", hint: "é˜¿ ç•¢ æ¨‚ è¸¢" }, { en: "Accept", zh: "æ¥å—", hint: "å™ ã„™ã„Ÿ ã„† ã„Š" },
                { en: "Adult", zh: "æˆäºº", hint: "å™ å¤§ ã„› ã„Š" }, { en: "Advice", zh: "å»ºè­°", hint: "å™ ã„‰ ã„ˆã„Ë‹ æ­»" },
                { en: "Create", zh: "å‰µé€ ", hint: "å¯ ç‘ ã„Ÿ ã„Š" }, { en: "Damage", zh: "æå®³", hint: "çˆ¹ ç±³ å±…" },
                { en: "Device", zh: "è£ç½®", hint: "åº• ã„ˆã„Ë‹ æ­»" }, { en: "Effect", zh: "æ•ˆæœ", hint: "ä»¥ è² ã„ ã„Š" }
            ],
            level6: [
                { en: "Abandon", zh: "æ”¾æ£„", hint: "å™ ç­ é “" }, { en: "Absolute", zh: "çµ•å°çš„", hint: "è‰¾ ã„… æœ é­¯ ã„Š" },
                { en: "Academic", zh: "å­¸è¡“çš„", hint: "è‰¾ å¡ çˆ¹ ç±³ ã„" }, { en: "Access", zh: "å­˜å–/é€šé“", hint: "è‰¾ ã„ ã„™ã„Ÿ æ­»" },
                { en: "Achieve", zh: "é”æˆ", hint: "å™ å€ å¤«" }, { en: "Benefit", zh: "åˆ©ç›Š", hint: "è² å‘¢ è²» ã„Š" },
                { en: "Capture", zh: "æ•æ‰", hint: "å‡± æ™® å€ å…’" }, { en: "Caution", zh: "å°å¿ƒ", hint: "è€ƒ ç‚«" }
            ],
            level7: [
                { en: "Hello", zh: "ä½ å¥½", hint: "å“ˆ å›‰" }, { en: "Goodbye", zh: "å†è¦‹", hint: "å¤ æ°" },
                { en: "Please", zh: "è«‹", hint: "æ™® éº— æ­»" }, { en: "Thanks", zh: "è¬è¬", hint: "æ•£ ã„ æ­»" },
                { en: "Help", zh: "å¹«å¿™", hint: "é»‘ ã„› ã„†" }, { en: "Water", zh: "æ°´", hint: "ç“¦ ç‰¹" },
                { en: "Food", zh: "é£Ÿç‰©", hint: "å¤« ã„‰" }, { en: "Sleep", zh: "ç¡è¦º", hint: "æ­» éº— ã„†" }
            ],
            level8: [
                { en: "Do", zh: "åš (åŸå½¢)", hint: "åº¦" }, { en: "Did", zh: "åš (éå»å¼)", hint: "å¼Ÿ ã„‰" },
                { en: "Go", zh: "å» (åŸå½¢)", hint: "å¤ " }, { en: "Went", zh: "å» (éå»å¼)", hint: "æº« ã„Š" },
                { en: "Eat", zh: "åƒ (åŸå½¢)", hint: "ä¼Š ã„Š" }, { en: "Ate", zh: "åƒ (éå»å¼)", hint: "ã„Ÿ ã„Š" },
                { en: "See", zh: "çœ‹ (åŸå½¢)", hint: "æˆ²" }, { en: "Saw", zh: "çœ‹ (éå»å¼)", hint: "ç´¢" }
            ],
            level9: [
                { en: "Hypothesis", zh: "å‡è¨­", hint: "æµ· æ€• ã„œ å–œ æ­»" }, { en: "Metaphor", zh: "éš±å–»", hint: "å¦¹ å¡” ä½›" },
                { en: "Psychology", zh: "å¿ƒç†å­¸", hint: "è³½ å¡ æ¨‚ å±…" }, { en: "Sustainable", zh: "æ°¸çºŒçš„", hint: "è–© æ­» ã„Šã„Ÿ è¨¥ ä¼¯" },
                { en: "Ambiguous", zh: "æ¨¡ç¨œå…©å¯çš„", hint: "å®‰ ç•¢ æ¡‚ é¤“ æ­»" }, { en: "Dilemma", zh: "é€²é€€å…©é›£", hint: "åº• ç´¯ ç½µ" },
                { en: "Commodity", zh: "å•†å“", hint: "å¯ ç½µ åº• è¸¢" }, { en: "Diversity", zh: "å¤šæ¨£æ€§", hint: "å¸¶ ä½› è‰² è¸¢" }
            ],
            level10: [
                { en: "Comprehensive", zh: "ç¶œåˆçš„/è©³ç›¡çš„", hint: "åº· æ™® ç‘ äº¨ è¥¿ å¤«" }, { en: "Distinguish", zh: "å€åˆ¥", hint: "æ»´ æ­» ä¸ è²´ è¨±" },
                { en: "Negotiate", zh: "è«‡åˆ¤", hint: "å‘¢ è³¼ å–œ ã„Ÿ ã„Š" }, { en: "Appreciate", zh: "æ„Ÿæ¿€/æ¬£è³", hint: "å™ æ™® ç‘ å–œ ã„Ÿ ã„Š" },
                { en: "Potential", zh: "æ½›åŠ›", hint: "æ³¢ èˆ” ç§€" }, { en: "Exaggerate", zh: "èª‡å¼µ", hint: "ä¸€ è‘› ç´® æƒ¹ ç‘ ã„Š" },
                { en: "Acquire", zh: "ç²å¾—/ç¿’å¾—", hint: "å™ å¡Š å…’" }, { en: "Efficient", zh: "æœ‰æ•ˆç‡çš„", hint: "ä»¥ è² ç‚« ã„Š" }
            ]
        };

        const LEVELS = [
            { id: 'level1', title: '1. æ¯éŸ³åŸºç¤', desc: 'A, E, I, O, U èˆ‡ç°¡å–®å­—', color: 'bg-yellow-400' },
            { id: 'level2', title: '2. æ‹¼è®€ç·´ç¿’', desc: 'C-a-t Cat çµ„åˆéŸ³', color: 'bg-orange-400' },
            { id: 'level3', title: '3. åœ‹å°å–®å­—', desc: 'åŸºç¤ç”Ÿæ´»å­—å½™', color: 'bg-green-400' },
            { id: 'level4', title: '4. åœ‹ä¸­å–®å­—', desc: 'é€²éšé–±è®€å­—å½™', color: 'bg-teal-400' },
            { id: 'level5', title: '5. é«˜ä¸€æ ¸å¿ƒ', desc: 'å­¸è¡“å…¥é–€å­—å½™', color: 'bg-blue-400' },
            { id: 'level6', title: '6. é«˜äºŒé€²éš', desc: 'æ·±åº¦é–±è®€å­—å½™', color: 'bg-indigo-400' },
            { id: 'level7', title: '7. æ—¥å¸¸æœƒè©±', desc: 'ç”Ÿæ´»å¿…å‚™çŸ­èª', color: 'bg-purple-400' },
            { id: 'level8', title: '8. æ–‡æ³•å‹•è©', desc: 'å‹•è©è®ŠåŒ–èˆ‡æ–‡æ³•', color: 'bg-pink-400' },
            { id: 'level9', title: '9. é«˜ä¸‰ç²¾é€²', desc: 'å­¸è¡“èˆ‡æŠ½è±¡æ¦‚å¿µ', color: 'bg-rose-400' },
            { id: 'level10', title: '10. å­¸æ¸¬/å¤šç›Š', desc: 'é«˜é »è€ƒè©¦å¿…å‚™å–®å­—', color: 'bg-stone-500' }
        ];

        // ==========================================
        //  æ‡‰ç”¨ç¨‹å¼é‚è¼¯ (App Logic)
        // ==========================================

        let state = {
            view: 'home',
            currentLevelId: '',
            questions: [],
            currentIndex: 0,
            score: 0,
            status: 'idle',
            transcript: '',
            debugMsg: '',
            showMicModal: false,
            isSecure: window.location.protocol === 'https:' || window.location.hostname === 'localhost',
            speechSupported: false,
            ttsSupported: false
        };

        function logDebug(msg) {
            console.log(msg);
            state.debugMsg = msg;
            const debugEl = document.getElementById('debug-area');
            if(debugEl) debugEl.textContent = msg;
        }

        // --- æ ¸å¿ƒï¼šèªéŸ³åŠŸèƒ½æª¢æ¸¬ ---
        // 1. TTS æª¢æ¸¬èˆ‡åˆå§‹åŒ–
        function initTTS() {
            if ('speechSynthesis' in window) {
                state.ttsSupported = true;
                // å¼·åˆ¶è§¸ç™¼ getVoicesï¼Œè§£æ±º Android/iOS ç¬¬ä¸€æ¬¡ç©ºå€¼å•é¡Œ
                window.speechSynthesis.getVoices();
                window.speechSynthesis.onvoiceschanged = () => {
                    console.log("èªéŸ³åŒ…å·²è¼‰å…¥:", window.speechSynthesis.getVoices().length);
                };
            } else {
                state.ttsSupported = false;
                console.warn("æ­¤ç€è¦½å™¨ä¸æ”¯æ´ TTS");
            }
        }

        // 2. STT æª¢æ¸¬
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        
        function initSTT() {
            if (SpeechRecognition) {
                state.speechSupported = true;
                recognition = new SpeechRecognition();
                recognition.lang = 'en-US';
                recognition.continuous = false;
                recognition.interimResults = false;
                
                recognition.onstart = () => {
                    state.status = 'listening';
                    logDebug("ğŸ¤ éº¥å…‹é¢¨å•Ÿå‹•ä¸­...");
                    render();
                };
                
                recognition.onresult = (event) => {
                    const result = event.results[0][0].transcript;
                    state.transcript = result;
                    evaluate(result);
                };
                
                recognition.onerror = (e) => {
                    let msg = "è¾¨è­˜éŒ¯èª¤";
                    if(e.error === 'not-allowed') msg = "âŒ æ¬Šé™è¢«æ‹’çµ• (è«‹æª¢æŸ¥è¨­å®š)";
                    else if(e.error === 'no-speech') msg = "âŒ æ²’è½åˆ°è²éŸ³ï¼Œè«‹å†è©¦ä¸€æ¬¡";
                    else if(e.error === 'network') msg = "âŒ ç¶²è·¯éŒ¯èª¤ (éœ€é€£ç¶²)";
                    state.status = 'idle';
                    logDebug(msg);
                    render();
                };
                
                recognition.onend = () => {
                    if (state.status === 'listening') {
                        state.status = 'idle';
                        render();
                    }
                };
            } else {
                state.speechSupported = false;
            }
        }

        // èªéŸ³åˆæˆ (TTS) åŸ·è¡Œ
        function speak(text) {
            if (!state.ttsSupported) {
                logDebug("âŒ ç€è¦½å™¨ä¸æ”¯æ´ç™¼éŸ³åŠŸèƒ½");
                return;
            }
            try {
                window.speechSynthesis.cancel(); // å…ˆåœæ­¢ä¸Šä¸€å€‹
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'en-US';
                u.rate = 0.8;
                
                // å˜—è©¦é¸æ“‡æ¯”è¼ƒå¥½çš„è‹±æ–‡è²éŸ³
                const voices = window.speechSynthesis.getVoices();
                const enVoice = voices.find(v => v.lang === 'en-US') || voices.find(v => v.lang.includes('en'));
                if(enVoice) u.voice = enVoice;

                window.speechSynthesis.speak(u);
            } catch (err) {
                logDebug("ç™¼éŸ³éŒ¯èª¤: " + err.message);
            }
        }

        // å•Ÿå‹•éŒ„éŸ³ (å«éŒ¯èª¤è™•ç†)
        function startRecording() {
            // æƒ…æ³ A: ç€è¦½å™¨æ ¹æœ¬ä¸æ”¯æ´ API (ä¾‹å¦‚ iOS Safari ä¸€èˆ¬æ¨¡å¼)
            if (!state.speechSupported) {
                alert("æŠ±æ­‰ï¼Œæ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ã€‚\n\nå»ºè­°ä½¿ç”¨ï¼š\n1. Android Chrome\n2. é›»è…¦ç‰ˆ Chrome/Edge\n(iOS ç›®å‰æ”¯æ´åº¦è¼ƒå·®)");
                return;
            }

            // æƒ…æ³ B: æ”¯æ´ API ä½†æ²’æœ‰ HTTPS (å¸¸è¦‹åŸå› )
            if (!state.isSecure) {
                alert("âš ï¸ éº¥å…‹é¢¨å®‰å…¨è­¦å‘Š\n\næ‚¨ç›®å‰çš„ç¶²å€ä¸æ˜¯ HTTPS å®‰å…¨é€£ç·šï¼Œç€è¦½å™¨å¯èƒ½æœƒå°é–éº¥å…‹é¢¨ã€‚\n\nè«‹å°‡æª”æ¡ˆä¸Šå‚³è‡³ GitHub Pages æˆ–ä½¿ç”¨ localhost æ¸¬è©¦ã€‚");
                // é›–ç„¶è­¦å‘Šï¼Œé‚„æ˜¯å˜—è©¦å•Ÿå‹•çœ‹çœ‹ï¼Œä¹Ÿè¨±ä½¿ç”¨è€…æœ‰è¨­å®šä¾‹å¤–
            }

            try {
                recognition.start();
            } catch(e) {
                console.error(e);
                alert("ç„¡æ³•å•Ÿå‹•éº¥å…‹é¢¨: " + e.message);
            }
        }

        // è©•ä¼°é‚è¼¯
        function evaluate(userSay) {
            state.status = 'evaluating';
            const currentQ = state.questions[state.currentIndex];
            const target = currentQ.en.toLowerCase();
            const input = userSay.toLowerCase();
            
            const isCorrect = input.includes(target) || target.includes(input);
            
            if (isCorrect) state.score += 10;
            
            speak(currentQ.en);
            render();

            setTimeout(() => {
                nextQuestion();
            }, 2000);
        }

        function nextQuestion() {
            if (state.currentIndex < state.questions.length - 1) {
                state.currentIndex++;
                state.status = 'idle';
                state.transcript = '';
                render();
            } else {
                state.view = 'result';
                render();
                speak("Great job!");
            }
        }

        function startGame(levelId) {
            const allWords = WORD_DATA[levelId];
            state.questions = [...allWords].sort(() => 0.5 - Math.random()).slice(0, 10);
            state.currentLevelId = levelId;
            state.currentIndex = 0;
            state.score = 0;
            state.status = 'idle';
            state.transcript = '';
            
            state.view = 'game';
            state.showMicModal = true; 
            
            // åˆå§‹åŒ–é™¤éŒ¯è¨Šæ¯
            if (!state.speechSupported) state.debugMsg = "âš ï¸ ç€è¦½å™¨ç„¡éŒ„éŸ³åŠŸèƒ½";
            else if (!state.isSecure) state.debugMsg = "âš ï¸ éå®‰å…¨é€£ç·šï¼Œéº¥å…‹é¢¨å¯èƒ½å¤±æ•ˆ";
            else state.debugMsg = "æº–å‚™å°±ç·’";
            
            render();
        }

        function confirmMic(enable) {
            state.showMicModal = false;
            render();
            
            // é»æ“Šäº‹ä»¶ä¸­ç›´æ¥è§¸ç™¼ speakï¼Œé€™æ˜¯è§£é–æ‰‹æ©ŸèªéŸ³çš„é—œéµ
            speak(state.questions[0].en);

            if (enable && state.speechSupported) {
                // å˜—è©¦é å…ˆå•Ÿå‹•ä¸€æ¬¡éº¥å…‹é¢¨è«‹æ±‚æ¬Šé™
                startRecording();
            }
        }

        function goHome() {
            state.view = 'home';
            render();
        }

        function render() {
            const app = document.getElementById('app');
            let html = '';

            // --- HTTPS è­¦å‘Šæ¢ ---
            let secureWarning = '';
            if (!state.isSecure && state.view === 'home') {
                secureWarning = `
                    <div class="bg-amber-100 text-amber-800 px-4 py-2 text-xs text-center border-b border-amber-200">
                        âš ï¸ æª¢æ¸¬åˆ°éå®‰å…¨é€£ç·š (HTTP/File)<br>éº¥å…‹é¢¨åŠŸèƒ½å¯èƒ½æœƒè¢«ç€è¦½å™¨å°é–
                    </div>
                `;
            }

            // --- éº¥å…‹é¢¨æ¬Šé™è©¢å• Modal ---
            let modalHtml = '';
            if (state.showMicModal) {
                modalHtml = `
                    <div class="absolute inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 fade-in">
                        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl text-center">
                            <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-white shadow-lg shadow-indigo-200">
                                <i data-lucide="mic" class="w-8 h-8"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-800 mb-2">æº–å‚™å¥½äº†å—ï¼Ÿ</h3>
                            <p class="text-slate-500 mb-6 text-sm">
                                é»æ“Šã€Œé–‹å§‹ã€å¾Œï¼Œè«‹å…è¨±éº¥å…‹é¢¨æ¬Šé™ã€‚<br>
                                (è‹¥æ‰‹æ©Ÿæ²’è²éŸ³ï¼Œè«‹ç¢ºèªéœéŸ³éµå·²é—œé–‰)
                            </p>
                            <div class="flex flex-col gap-3">
                                <button onclick="confirmMic(true)" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md">
                                    é–‹å§‹ç·´ç¿’ (é–‹å•Ÿè²éŸ³/éº¥å…‹é¢¨)
                                </button>
                                <button onclick="confirmMic(false)" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-500 font-bold py-3 rounded-xl transition-colors">
                                    å…ˆä¸è¦
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (state.view === 'home') {
                html = `
                    ${secureWarning}
                    <div class="w-full p-6 pb-20 fade-in">
                        <header class="mb-8 text-center">
                            <h1 class="text-3xl font-black text-indigo-600 mb-1">English Master</h1>
                            <p class="text-sm text-slate-500">ç™¼éŸ³ãƒ»è½åŠ›ãƒ»å–®å­—ç‰¹è¨“</p>
                            ${!state.speechSupported ? '<div class="mt-2 bg-red-100 text-red-600 px-3 py-1 rounded text-xs inline-block">âš ï¸ æ­¤ç€è¦½å™¨ä¸æ”¯æ´éŒ„éŸ³ API</div>' : ''}
                        </header>
                        
                        <div class="grid gap-4">
                            ${LEVELS.map(lvl => `
                                <button onclick="startGame('${lvl.id}')" class="relative overflow-hidden rounded-2xl shadow-md transition-transform active:scale-95 text-left">
                                    <div class="${lvl.color} p-4 text-white">
                                        <div class="font-bold text-lg">${lvl.title}</div>
                                        <div class="text-xs opacity-90">${lvl.desc}</div>
                                    </div>
                                    <div class="absolute right-4 top-1/2 -translate-y-1/2 text-white/30">
                                        <i data-lucide="play" class="w-12 h-12 fill-current"></i>
                                    </div>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else if (state.view === 'game') {
                const q = state.questions[state.currentIndex];
                const isEvaluating = state.status === 'evaluating';
                const isListening = state.status === 'listening';
                
                let cardClass = "bg-white border-4 border-slate-100";
                let feedbackHtml = "";
                
                if (isEvaluating) {
                    const isCorrect = state.transcript.toLowerCase().includes(q.en.toLowerCase());
                    cardClass = isCorrect ? "bg-green-50 border-4 border-green-200" : "bg-red-50 border-4 border-red-200";
                    feedbackHtml = isCorrect 
                        ? `<div class="absolute top-0 left-0 w-full h-full flex items-center justify-center pointer-events-none correct-anim"><span class="text-8xl">ğŸ‰</span></div>`
                        : `<div class="absolute top-0 left-0 w-full h-full flex items-center justify-center pointer-events-none shake"><span class="text-8xl">ğŸ’ª</span></div>`;
                }

                html = `
                    <div class="w-full h-full flex flex-col p-6 fade-in relative">
                        ${modalHtml}
                        
                        <div class="flex justify-between items-center mb-6">
                            <button onclick="goHome()" class="p-2 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200">
                                <i data-lucide="arrow-left"></i>
                            </button>
                            <div class="font-bold text-slate-400">
                                ${state.currentIndex + 1} / ${state.questions.length}
                            </div>
                            <div class="bg-yellow-100 text-yellow-600 px-3 py-1 rounded-full font-bold text-sm">
                                ${state.score} åˆ†
                            </div>
                        </div>

                        <div class="flex-1 flex flex-col items-center justify-center relative ${cardClass} rounded-3xl shadow-xl transition-colors duration-300 p-8 mb-4">
                            ${feedbackHtml}
                            <div class="text-2xl text-slate-500 font-medium mb-2">${q.zh}</div>
                            <div class="text-5xl font-black text-slate-800 mb-6 text-center leading-tight break-all">
                                ${q.en}
                            </div>
                            <div class="bg-indigo-50 text-indigo-600 px-6 py-3 rounded-xl text-lg font-bold border border-indigo-100 mb-6">
                                <span class="text-xs text-indigo-300 mr-2">è®€éŸ³</span>${q.hint}
                            </div>
                            <div class="h-8 text-center">
                                ${isListening ? '<span class="text-rose-500 animate-pulse font-bold tracking-widest">â— â— â—</span>' : ''}
                                ${state.transcript && !isListening ? `<span class="text-slate-400 text-sm">ä½ èªªäº†: "${state.transcript}"</span>` : ''}
                            </div>
                        </div>

                        <div id="debug-area" class="w-full text-center text-xs text-orange-400 bg-orange-50 p-2 rounded mb-4 h-8 flex items-center justify-center overflow-hidden">
                            ${state.debugMsg || 'ç³»çµ±æ­£å¸¸'}
                        </div>

                        <div class="flex items-center justify-center gap-6 mb-8">
                            <!-- ç™¼éŸ³æŒ‰éˆ•ï¼šç„¡è«–å¦‚ä½•éƒ½é¡¯ç¤º -->
                            <button onclick="speak('${q.en}')" class="w-16 h-16 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center active:bg-slate-200 transition-colors shadow-sm">
                                <i data-lucide="volume-2" class="w-8 h-8"></i>
                            </button>

                            <!-- éº¥å…‹é¢¨æŒ‰éˆ•ï¼šç„¡è«–å¦‚ä½•éƒ½é¡¯ç¤ºï¼Œé»æ“Šæ‰æª¢æŸ¥ -->
                            <button onclick="startRecording()" class="group relative w-24 h-24 rounded-full flex items-center justify-center transition-all duration-300 ${isListening ? 'scale-110' : 'hover:scale-105 active:scale-95'}">
                                
                                ${isListening ? `
                                    <div class="absolute inset-0 bg-rose-500 rounded-full animate-ping opacity-20"></div>
                                    <div class="absolute -inset-3 bg-rose-500/20 rounded-full animate-pulse"></div>
                                ` : `
                                    <div class="absolute inset-0 bg-indigo-600/20 rounded-full blur-xl group-hover:bg-indigo-600/30 transition-all"></div>
                                `}
                                
                                <div class="relative w-full h-full rounded-full flex items-center justify-center shadow-2xl border-4 border-white transition-all duration-300
                                    ${isListening 
                                        ? 'bg-gradient-to-br from-rose-500 to-red-600 shadow-rose-500/50' 
                                        : 'bg-gradient-to-br from-indigo-500 to-blue-600 shadow-indigo-500/40'}">
                                    
                                    <i data-lucide="mic" class="w-10 h-10 text-white transition-transform duration-300 ${isListening ? 'scale-110' : ''}"></i>
                                </div>
                                
                                ${!isListening ? `
                                    <div class="absolute -bottom-8 text-xs font-bold text-slate-400 bg-white px-2 py-0.5 rounded-full shadow-sm border border-slate-100 opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
                                        æŒ‰æˆ‘éŒ„éŸ³
                                    </div>
                                ` : ''}
                            </button>
                        </div>
                        
                        <!-- åº•éƒ¨è¼”åŠ©æç¤ºï¼Œå¦‚æœä¸èƒ½éŒ„éŸ³æ™‚é¡¯ç¤ºæ–‡å­— -->
                        ${!state.speechSupported ? '<div class="text-xs text-center text-slate-300">ç›®å‰ç€è¦½å™¨åƒ…æ”¯æ´è½åŠ›ç·´ç¿’</div>' : ''}
                    </div>
                `;
            } else if (state.view === 'result') {
                html = `
                    <div class="w-full h-full flex flex-col items-center justify-center p-8 fade-in text-center">
                        <div class="text-8xl mb-4 animate-bounce">ğŸ†</div>
                        <h2 class="text-3xl font-black text-slate-800 mb-2">æ¸¬é©—å®Œæˆï¼</h2>
                        <div class="bg-white border-2 border-slate-100 w-full rounded-2xl p-6 mb-8 shadow-sm">
                            <div class="text-slate-400 text-sm mb-1">ç¸½å¾—åˆ†</div>
                            <div class="text-6xl font-black text-indigo-500">${state.score}</div>
                        </div>
                        <button onclick="goHome()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-all">
                            å›åˆ°ä¸»é¸å–®
                        </button>
                    </div>
                `;
            }

            app.innerHTML = html;
            lucide.createIcons();
        }

        // å•Ÿå‹•æª¢æ¸¬
        initTTS();
        initSTT();
        render();

    </script>
</body>
</html>